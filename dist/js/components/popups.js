import{getActionAreaMarkup,getDialogMarkup,getLightboxMarkup}from"../markup/popups.js";import{adjustExpandalbeInput}from"../abstracts/styles.js";import{validateFormData}from"../auth/formValidation.js";let lastFocusedElement;export const Dialogs={postCreation:{purpose:"prompt",removeAfterClose:!1,label:"Create a new post",textContent:{heading:"new post",actionBtn:'<span class="u-sr-only">Submit your</span> post'},contentMarkup:"NewPostFormMarkup"},postUpdate:{purpose:"prompt",removeAfterClose:!1,label:"Edit your post",textContent:{heading:"Edit post",actionBtn:'Edit <span class="u-sr-only">your post</span>'},contentMarkup:"NewPostFormMarkup"},commentCreation:{purpose:"prompt",label:"Create a new comment",removeAfterClose:!1,textContent:{heading:"new comment",actionBtn:'<span class="u-sr-only">Submit your</span> comment'},contentMarkup:"newCommentFormMarkup"},passwordEdit:{purpose:"prompt",removeAfterClose:!1,label:"Change your accout password",textContent:{heading:"change password",actionBtn:'change <span class="u-sr-only"> your password</span>'},contentMarkup:"passwordChangeFormMarkup"},usernameEdit:{purpose:"prompt",removeAfterClose:!1,label:"Change your password",textContent:{heading:"change username",actionBtn:'change <span class="u-sr-only"> your username</span>'},contentMarkup:"usernameChangeFormMarkup"},emailEdit:{purpose:"prompt",removeAfterClose:!1,label:"Change your accout email",textContent:{heading:"change email",actionBtn:'change <span class="u-sr-only"> your email</span>'},contentMarkup:"emailChangeFormMarkup"},deletePost:{purpose:"confirm",removeAfterClose:!0,label:"Delete the post",actionBtnType:"accent",textContent:{heading:"Delete post",actionBtn:"Delete"},contentMarkup:"postDeleteFormMarkup"},hidePost:{purpose:"confirm",removeAfterClose:!0,label:"Hide the post",actionBtnType:"accent",textContent:{heading:"Hide post",actionBtn:"Hide"},contentMarkup:"postHideFormMarkup"},showPostComments:{purpose:"present",label:"Post comments",removeAfterClose:!1,textContent:{heading:"comments"},contentMarkup:"postCommentsMarkup"}};export const GlobalDialogs={newPost:null,passwordEdit:null,usernameEdit:null,changeEmailEdit:null};export function createPopup(e,t){const o=document.createElement("div");return o.className="c-popup-frame",o.tabIndex=0,o.setAttribute("data-remove",t??!0),o.innerHTML=`\n    <div class="c-popup__inner l-container" data-width="narrow">\n      ${e}\n    </div>\n    `,showPopup(o),o}export function createLightbox(){const e=document.querySelector(`[data-img-id="${this.getAttribute("data-target")}"]`);createPopup(getLightboxMarkup(e))}export function createDialog(e,t){const o=createPopup(getDialogMarkup(e),e.removeAfterClose);return o.role="dialog",o.ariaLabel=e.label,o.setAttribute("data-requires-update",""),o.querySelectorAll(".js-expandable-input")?.forEach((e=>adjustExpandalbeInput(e))),handleDialogSubmit(o,e,t),o}async function handleDialogSubmit(e,t,o){const n=t.purpose;let a;if("confirm"===n)e.querySelector(".js-dialog-content").insertAdjacentHTML("afterend",getActionAreaMarkup(t)),a=e.querySelector(".js-action-btn"),e.querySelector(".js-action-btn").addEventListener("click",(async()=>{a.classList.add("js-checking"),s(await o())}));else if("prompt"===n){const n=e.querySelector("form");n.insertAdjacentHTML("beforeend",getActionAreaMarkup(t)),a=e.querySelector(".js-action-btn"),n.addEventListener("submit",(async e=>{if(e.preventDefault(),!validateFormData(n))return;a.classList.add("js-checking"),s(await o(new FormData(n)))}))}function s(t){t?(document.querySelector(".js-error-msg")?.remove(),closePopup(e,!0)):a.classList.remove("js-checking")}}export function showPopup(e){lastFocusedElement=document.activeElement,document.body.insertAdjacentElement("beforeend",e),e.style.removeProperty("display"),setTimeout((()=>{e.classList.add("js-show-up"),handlePopupAccessibility(e)}))}function handlePopupAccessibility(e){const t=e.querySelectorAll(".js-close-popup"),o=e.querySelector("[data-focus]");o?o.focus():t[0].focus(),e.addEventListener("mousedown",handlePopupMousedownEvent),e.addEventListener("keydown",handleKeydownEvent),t.forEach((t=>t.addEventListener("click",(()=>closePopup(e)))))}function handlePopupMousedownEvent(e){if(!this.classList.contains("js-show-up"))return;const t=e.target;if(3===e.which||2===e.button)return;const o=this.querySelector(".c-popup__inner");o.isSameNode(t)||o.contains(t)||closePopup(this)}function handleKeydownEvent(e){if("Escape"!==e.key&&27!==e.keyCode){if("Tab"===e.key||9===e.keyCode){const t=this.querySelectorAll("button, input, a"),o=t[0],n=t[t.length-1],a=document.activeElement;e.shiftKey?a.isSameNode(o)&&(e.preventDefault(),t[t.length-1].focus()):a.isSameNode(n)&&(e.preventDefault(),t[0].focus())}}else closePopup(this)}export function closePopup(e,t){e.classList.remove("js-show-up"),e.addEventListener("transitionend",(function o(){this.style.display="none",(t||"true"===e.getAttribute("data-remove"))&&this.remove();this.removeEventListener("mousedown",handlePopupMousedownEvent),this.removeEventListener("transitionend",o),this.removeEventListener("keydonw",handleKeydownEvent)})),lastFocusedElement.focus()}