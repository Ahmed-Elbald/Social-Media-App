import{formatCommentsCount,getCommentMarkup,getPostMarkup}from"../markup/posts.js";import{addFillersText}from"../abstracts/helpers.js";import{makeRequest,getRequestURL}from"../auth/requests.js";import{getUserToken}from"../auth/authorization.js";import{Dialogs,GlobalDialogs,createDialog,showPopup}from"./popups.js";const postsContainer=document.querySelector(".js-posts-container");let imgFiller;class Post{static paginate(t,e){const s=new IntersectionObserver((o=>{o.forEach((o=>{o.isIntersecting&&(addPosts(e),s.unobserve(t))}))}),{threshold:.25});s.observe(t)}constructor(t,e){this.id=t.id,this.self=document.createElement("article"),this.data={body:t.body,commentsCount:t.comments_count,imgSrc:t.image},this.dialogs={edit:null,newComment:null,comments:null},this.init(t,e)}init(t,e){this.self.className="c-post js-post",this.self.innerHTML=getPostMarkup(t),addPostImg(this.self,t.image),this.addInteractivity(),this.addToPage(e)}addInteractivity(){this.self.querySelector(".js-hide-post").addEventListener("click",(()=>this.hide())),this.self.querySelector(".js-delete-post")?.addEventListener("click",(()=>this.delete())),this.self.querySelector(".js-edit-post")?.addEventListener("click",(()=>this.edit())),this.self.querySelector(".js-new-comment").addEventListener("click",(()=>this.createComment())),this.self.querySelector(".js-show-comments").addEventListener("click",(()=>this.showComments()))}addToPage(t){const e=document.createElement("li");e.append(this.self),"user"===t?postsContainer.prepend(e):postsContainer.append(e)}update(){addFillersText(this.self,{body:this.data.body,commentsCount:formatCommentsCount(this.data.commentsCount)}),addPostImg(this.self,this.data.imgSrc);for(let t in this.dialogs)this.dialogs[t]&&(this.dialogs[t].remove(),this.dialogs[t]=null)}hide(){createDialog(Dialogs.hidePost,(()=>(this.self.remove(),!0)))}edit(){if(this.dialogs.edit)return void showPopup(this.dialogs.edit);const t=new FormData,e=createDialog(Dialogs.postUpdate,submitPost.bind(this,t));this.dialogs.edit=e,managePostForm.call(this,e,t)}delete(){createDialog(Dialogs.deletePost,deletePost.bind(this))}createComment(){this.dialogs.newComment?showPopup(this.dialogs.newComment):this.dialogs.newComment=createDialog(Dialogs.commentCreation,createNewComment.bind(this))}showComments(){if(this.dialogs.comments)return showPopup(this.dialogs.comments),void handleCommentsDisplay.call(this);this.dialogs.comments=createDialog(Dialogs.showPostComments),handleCommentsDisplay.call(this)}}async function getPostsData(t){const e=await makeRequest({url:t});return[e.data,e.links?.next]}function addPostImg(t,e){const s=t.querySelector(".js-img-container"),o=s.querySelector("img");getPostImg(e).then((t=>{s.classList.add("js-has-img"),o.src=t}),(t=>{o.removeAttribute("src"),s.classList.remove("js-has-img")}))}function getPostImg(t){if("string"==typeof t){const e=document.createElement("img");return e.src=t,new Promise(((s,o)=>{e.addEventListener("load",(()=>{1!==e.naturalHeight?s(t):o()}))}))}return Promise.reject()}async function deletePost(){await makeRequest({method:"DELETE",url:getRequestURL("posts",this.id),headers:{authorization:getUserToken()},body:{}}),this.self.remove();for(let t in this.dialogs)this.dialogs[t]?.remove();return!0}async function createNewComment(t){return await makeRequest({method:"POST",url:getRequestURL("postComments",this.id),headers:{"Content-Type":"application/json",authorization:getUserToken()},body:JSON.stringify({body:t.get("new-comment-body")})}),this.data.commentsCount++,this.update(),!0}async function handleCommentsDisplay(){const t=this.dialogs.comments;if(!t.hasAttribute("data-requires-update"))return;t.removeAttribute("data-requires-update");let e=await makeRequest({url:getRequestURL("postComments",this.id),headers:{authorization:getUserToken()},action:"getPostComments"}).then((t=>t.data.reverse()));e=await Promise.all(e.map((async t=>({id:t.id,body:t.body,createdAt:t.created_at,author:await makeRequest({url:getRequestURL("getUser",t.author_id)}).then((t=>t.data))}))));const s=t.querySelector(".js-post-comments");0===e.length?s.innerHTML="<p>there is no comments for this post</p>":s.innerHTML=e.map((t=>getCommentMarkup(t))).join(""),s.classList.add("js-content-loaded")}!async function(){const t=await fetch("./assets/images/post-img-filler.jpg"),e=await t.blob();imgFiller=new File([e],"image-filler.jpg",{type:e.type})}();export async function addPosts(t){let[e,s]=await getPostsData(t);"/profile.html"===pagePathName?e=e.reverse():"/home.html"===pagePathName&&(e=e.sort((()=>Math.random()-.5))),e.forEach(((t,o)=>{const i=new Post(t);s&&e.length-1===o&&Post.paginate(i.self,s)}))}export function managePostForm(t,e){const s=t.querySelector(".js-img-container"),o=s.querySelector("img"),i=s.querySelector(".js-img-remover"),a=t.querySelector(".js-post-body"),n=t.querySelector("#post-img");function r(t){o.src=t,s.classList.add("js-has-img")}this&&t.hasAttribute("data-requires-update")&&async function(){const t=this.data,o=t.body;e.append("body",o),a.value=o,a.previousElementSibling.innerHTML=o,getPostImg(t.imgSrc).then((t=>r(t)),(t=>s.classList.remove("js-has-img")))}.call(this),t.removeAttribute("data-requires-update"),i.addEventListener("click",(function(){e.set("image",imgFiller),s.classList.remove("js-has-img")})),a.addEventListener("input",(function(){e.set("body",this.value)})),n.addEventListener("input",(function(){const t=this.files[0];e.set("image",t),r(URL.createObjectURL(t))}))}export async function submitPost(t){let e=this?.id;e&&t.append("_method","PUT");const s=await makeRequest({method:"POST",action:"newPost",url:getRequestURL("posts",e),headers:{Authorization:getUserToken()},body:t}).then((t=>t.data));return e?(this.data.body=s.body,this.data.commentsCount=s.comments_count,this.data.imgSrc=s.image,this.update()):(new Post(s,"user"),GlobalDialogs.newPost=null),!0}